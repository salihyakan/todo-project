{% extends "core/base.html" %}
{% load static %}

{% block title %}Pomodoro Zamanlayıcı - Üretkenlik Odaklı Çalışma{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #2c3e50;
        --secondary: #34495e;
        --accent: #e74c3c;
        --light: #f8f9fa;
        --dark: #2c3e50;
        --success: #27ae60;
        --warning: #f39c12;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
    }

    body {
        background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        color: var(--gray-800);
    }

    .pomodoro-container {
        max-width: 800px;
        margin: 2rem auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        box-shadow: 
            0 2px 4px rgba(0, 0, 0, 0.05),
            0 8px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
        border: 1px solid var(--gray-200);
    }

    .card {
        background: transparent;
        border: none;
        color: var(--gray-800);
    }

    .card-header {
        background: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid var(--gray-200);
        font-weight: 600;
        font-size: 1.3rem;
        padding: 1.5rem;
        color: var(--gray-800);
        text-align: center;
    }

    .card-body {
        padding: 2rem;
    }

    .pomodoro-timer {
        font-size: 4rem;
        font-weight: 300;
        margin: 1.5rem 0;
        transition: all 0.3s ease;
        color: var(--gray-900);
        font-feature-settings: "tnum";
        font-variant-numeric: tabular-nums;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .progress-container {
        width: 100%;
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        margin: 2rem 0;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: var(--gray-600);
        border-radius: 3px;
        transition: width 1s linear;
    }

    .btn-pomodoro {
        padding: 0.8rem 1.8rem;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 10px;
        border: 1px solid var(--gray-300);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 130px;
        margin: 0.3rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .btn-pomodoro:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-pomodoro:active {
        transform: translateY(0);
    }

    #start-pomodoro {
        background: var(--gray-800);
        color: white;
        border-color: var(--gray-800);
    }

    #start-pomodoro:hover {
        background: var(--gray-900);
        border-color: var(--gray-900);
    }

    #pause-pomodoro {
        background: white;
        color: var(--gray-700);
        border-color: var(--gray-300);
    }

    #pause-pomodoro:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }

    #reset-pomodoro {
        background: white;
        color: var(--gray-700);
        border-color: var(--gray-300);
    }

    #reset-pomodoro:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--gray-700);
    }

    .form-control {
        background: white;
        border: 1px solid var(--gray-300);
        color: var(--gray-800);
        padding: 0.7rem 1rem;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        background: white;
        border-color: var(--gray-500);
        box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        color: var(--gray-900);
    }

    .stats-container {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 1px solid var(--gray-200);
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
        color: var(--gray-900);
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--gray-600);
        font-weight: 500;
    }

    .motivation-card {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 1.2rem;
        margin: 1.5rem 0;
        text-align: center;
        font-size: 0.95rem;
        border-left: 4px solid var(--gray-400);
        color: var(--gray-700);
        font-style: italic;
    }

    .history-item {
        background: var(--gray-50);
        border-radius: 8px;
        padding: 0.8rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        border: 1px solid var(--gray-200);
    }

    .history-item:hover {
        background: var(--gray-100);
        transform: translateX(2px);
    }

    .work-item {
        border-left: 4px solid var(--gray-600);
    }

    .break-item {
        border-left: 4px solid var(--gray-400);
    }

    .session-counter {
        display: inline-block;
        background: var(--gray-600);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        font-weight: 600;
        margin-right: 10px;
        font-size: 0.8rem;
    }

    .phase-indicator {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        margin-left: 10px;
    }

    .work-phase {
        background: var(--gray-700);
        color: white;
    }

    .break-phase {
        background: var(--gray-400);
        color: white;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        cursor: pointer;
        padding: 0.5rem 0;
    }

    .history-content {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .history-content::-webkit-scrollbar {
        width: 4px;
    }

    .history-content::-webkit-scrollbar-track {
        background: var(--gray-100);
        border-radius: 2px;
    }

    .history-content::-webkit-scrollbar-thumb {
        background: var(--gray-400);
        border-radius: 2px;
    }

    .collapse-icon {
        transition: transform 0.3s ease;
        color: var(--gray-600);
    }

    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }

    .session-control {
        background: var(--gray-50);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 1px solid var(--gray-200);
    }

    .session-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 12px 15px;
        background: white;
        border-radius: 8px;
        font-weight: 600;
        border: 1px solid var(--gray-200);
        font-size: 0.9rem;
    }

    .session-progress {
        width: 100%;
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
    }

    .session-progress-bar {
        height: 100%;
        background: var(--gray-600);
        width: 0%;
        transition: width 0.5s ease;
    }

    .notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--gray-800);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 300px;
    }

    .notification.show {
        transform: translateX(0);
    }

    .phase-display {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .pomodoro-timer {
            font-size: 3.2rem;
        }

        .btn-container {
            flex-direction: column;
            align-items: center;
        }

        .btn-pomodoro {
            width: 100%;
            max-width: 280px;
            margin: 0.2rem;
        }

        .stat-number {
            font-size: 1.6rem;
        }

        .session-control {
            padding: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }
    }

    /* Focus state for accessibility */
    .btn-pomodoro:focus,
    .form-control:focus {
        outline: 2px solid var(--gray-500);
        outline-offset: 2px;
    }

    /* Animation for timer */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }

    .timer-pulse {
        animation: pulse 1s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<!-- Bildirim -->
<div class="notification" id="notification">
    <i class="fas fa-bell"></i>
    <span id="notification-text">Bildirim içeriği</span>
</div>

<div class="container py-4">
    <div class="pomodoro-container">
        <div class="card">
            <div class="card-header text-center">
                <i class="fas fa-clock me-2"></i>Pomodoro Zamanlayıcı
            </div>
            <div class="card-body">
                <!-- Faz gösterge -->
                <div class="phase-display text-center" id="phase-display">
                    Çalışma Zamanı
                    <span class="phase-indicator work-phase">Çalışma</span>
                </div>

                <!-- Zaman gösterge -->
                <div class="pomodoro-timer text-center" id="timer">
                    25:00
                </div>

                <!-- İlerleme çubuğu -->
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 100%"></div>
                </div>

                <!-- Oturum kontrolü -->
                <div class="session-control">
                    <div class="form-group">
                        <label for="session-count">
                            <i class="fas fa-tasks me-2"></i>Toplam Oturum Sayısı
                        </label>
                        <input type="number" class="form-control" id="session-count" min="1" max="20" value="4">
                    </div>

                    <div class="session-info">
                        <div>
                            <span>Tamamlanan: </span>
                            <span id="completed-sessions">0</span>
                        </div>
                        <div>
                            <span>Kalan: </span>
                            <span id="remaining-sessions">4</span>
                        </div>
                    </div>

                    <div class="session-progress">
                        <div class="session-progress-bar" id="session-progress-bar"></div>
                    </div>
                </div>

                <!-- Motivasyon kartı -->
                <div class="motivation-card" id="motivation-message">
                    "Konsantrasyon, başarının anahtarıdır. Şimdi odaklanma zamanı!"
                </div>

                <!-- İstatistikler -->
                <div class="stats-container">
                    <div class="row">
                        <div class="col-md-4 stat-item">
                            <div class="stat-number" id="completed-pomodoros">{{ redis_stats.completed|default:"0" }}</div>
                            <div class="stat-label">Tamamlanan</div>
                        </div>
                        <div class="col-md-4 stat-item">
                            <div class="stat-number" id="total-focus-time">{{ redis_stats.focus_time|default:"0" }}dk</div>
                            <div class="stat-label">Odak Süresi</div>
                        </div>
                        <div class="col-md-4 stat-item">
                            <div class="stat-number" id="total-break-time">{{ redis_stats.break_time|default:"0" }}dk</div>
                            <div class="stat-label">Mola Süresi</div>
                        </div>
                    </div>
                </div>

                <!-- Kontrol butonları -->
                <div class="d-flex justify-content-center flex-wrap btn-container">
                    <button id="start-pomodoro" class="btn btn-pomodoro">
                        <i class="fas fa-play me-2"></i> Başlat
                    </button>
                    <button id="pause-pomodoro" class="btn btn-pomodoro">
                        <i class="fas fa-pause me-2"></i> Duraklat
                    </button>
                    <button id="reset-pomodoro" class="btn btn-pomodoro">
                        <i class="fas fa-redo me-2"></i> Sıfırla
                    </button>
                </div>

                <!-- Süre ayarları -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="work-duration">
                                <i class="fas fa-briefcase me-2"></i>Çalışma Süresi (dk)
                            </label>
                            <input type="number" class="form-control" id="work-duration" value="25" min="1" max="60">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="break-duration">
                                <i class="fas fa-coffee me-2"></i>Mola Süresi (dk)
                            </label>
                            <input type="number" class="form-control" id="break-duration" value="5" min="1" max="30">
                        </div>
                    </div>
                </div>

                <!-- Pomodoro geçmişi -->
                <div class="mt-4">
                    <div class="history-header" data-bs-toggle="collapse" href="#historyCollapse" role="button">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Son Oturumlar</h5>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="historyCollapse">
                        <div class="history-content" id="pomodoro-history">
                            {% for session in redis_history %}
                            <div class="history-item {% if session.type == 'work' %}work-item{% else %}break-item{% endif %}">
                                <div>
                                    <span class="session-counter">{{ forloop.revcounter }}</span>
                                    <strong>{% if session.type == 'work' %}Çalışma Oturumu{% else %}Mola{% endif %}</strong>
                                </div>
                                <span>{{ session.duration }} dakika</span>
                            </div>
                            {% empty %}
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p>Henüz oturum kaydı bulunmuyor</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elementleri
    const timerDisplay = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const phaseDisplay = document.getElementById('phase-display');
    const motivationMessage = document.getElementById('motivation-message');
    const startBtn = document.getElementById('start-pomodoro');
    const pauseBtn = document.getElementById('pause-pomodoro');
    const resetBtn = document.getElementById('reset-pomodoro');
    const workDurationInput = document.getElementById('work-duration');
    const breakDurationInput = document.getElementById('break-duration');
    const pomodoroHistory = document.getElementById('pomodoro-history');
    const completedPomodoros = document.getElementById('completed-pomodoros');
    const totalFocusTime = document.getElementById('total-focus-time');
    const totalBreakTime = document.getElementById('total-break-time');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    const sessionCountInput = document.getElementById('session-count');
    const completedSessionsElement = document.getElementById('completed-sessions');
    const remainingSessionsElement = document.getElementById('remaining-sessions');
    const sessionProgressBar = document.getElementById('session-progress-bar');

    // Motivasyon mesajları
    const workMessages = [
        "Konsantrasyon, başarının anahtarıdır. Şimdi odaklanma zamanı!",
        "Her dakika değerli, iyi kullan!",
        "Hedeflerine bir adım daha yaklaşıyorsun.",
        "Mükemmel iş çıkarıyorsun, devam et!",
        "Zorluklar seni daha güçlü yapar. Pes etme!"
    ];

    const breakMessages = [
        "Mola zamanı! Zihnini dinlendir.",
        "Gözlerini dinlendirmeyi unutma.",
        "Kısa bir mola, daha iyi odaklanmana yardımcı olur.",
        "Ayağa kalk ve biraz hareket et.",
        "Derin bir nefes al ve rahatla."
    ];

    // Değişkenler
    let workTime = 25 * 60;
    let breakTime = 5 * 60;
    let timeLeft = workTime;
    let timerInterval = null;
    let isRunning = false;
    let isWorkPhase = true;
    let completedSessions = 0;
    let totalSessions = 4;
    let currentSession = 1;
    let totalFocusMinutes = parseInt('{{ redis_stats.focus_time|default:"0" }}');
    let totalBreakMinutes = parseInt('{{ redis_stats.break_time|default:"0" }}');

    // CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Pomodoro oturumunu kaydet
    function savePomodoroSession(sessionType, duration) {
        fetch('{% url "dashboard:save_pomodoro_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                type: sessionType,
                duration: duration
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                console.log('Pomodoro oturumu kaydedildi');
            }
        })
        .catch(error => {
            console.error('Oturum kaydedilemedi:', error);
        });
    }

    // Zamanı formatla
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    // İlerleme çubuğunu güncelle
    function updateProgressBar() {
        const totalTime = isWorkPhase ? workTime : breakTime;
        const percentage = (timeLeft / totalTime) * 100;
        progressBar.style.width = `${percentage}%`;
        progressBar.style.background = isWorkPhase ? 'var(--gray-700)' : 'var(--gray-500)';
    }

    // Oturum ilerlemesini güncelle
    function updateSessionProgress() {
        const progress = (completedSessions / totalSessions) * 100;
        sessionProgressBar.style.width = `${progress}%`;
        completedSessionsElement.textContent = completedSessions;
        remainingSessionsElement.textContent = totalSessions - completedSessions;
    }

    // Bildirim göster
    function showNotification(text) {
        notificationText.textContent = text;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Motivasyon mesajını güncelle
    function updateMotivationMessage() {
        const messages = isWorkPhase ? workMessages : breakMessages;
        const randomIndex = Math.floor(Math.random() * messages.length);
        motivationMessage.textContent = `"${messages[randomIndex]}"`;
    }

    // Faz göstergesini güncelle
    function updatePhaseDisplay() {
        if (isWorkPhase) {
            phaseDisplay.innerHTML = `Çalışma Zamanı (Oturum ${currentSession}/${totalSessions}) <span class="phase-indicator work-phase">Çalışma</span>`;
        } else {
            phaseDisplay.innerHTML = `Mola Zamanı (Oturum ${currentSession}/${totalSessions}) <span class="phase-indicator break-phase">Mola</span>`;
        }
    }

    // İstatistikleri güncelle
    function updateStats() {
        completedPomodoros.textContent = completedSessions;
        totalFocusTime.textContent = totalFocusMinutes + 'dk';
        totalBreakTime.textContent = totalBreakMinutes + 'dk';
    }

    // Timer animasyonu
    function animateTimer() {
        timerDisplay.classList.add('timer-pulse');
        setTimeout(() => {
            timerDisplay.classList.remove('timer-pulse');
        }, 1000);
    }

    // Zamanlayıcıyı başlat
    function startTimer() {
        if (isRunning) return;

        isRunning = true;
        startBtn.disabled = true;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = formatTime(timeLeft);
            updateProgressBar();
            animateTimer();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                startBtn.disabled = false;

                if (isWorkPhase) {
                    showNotification(`✓ Oturum ${currentSession} tamamlandı! Mola zamanı.`);
                    totalFocusMinutes += parseInt(workDurationInput.value);
                    savePomodoroSession('work', parseInt(workDurationInput.value));
                    isWorkPhase = false;
                    timeLeft = breakTime;
                } else {
                    showNotification(`✓ Mola bitti! Yeni çalışma oturumu başlıyor.`);
                    totalBreakMinutes += parseInt(breakDurationInput.value);
                    savePomodoroSession('break', parseInt(breakDurationInput.value));
                    isWorkPhase = true;
                    timeLeft = workTime;
                    completedSessions++;
                    currentSession++;

                    if (completedSessions >= totalSessions) {
                        showNotification('🎉 Tüm oturumlar tamamlandı! Tebrikler!');
                        isRunning = false;
                        updateSessionProgress();
                        updateStats();
                        return;
                    }
                }

                updatePhaseDisplay();
                updateMotivationMessage();
                updateStats();
                updateSessionProgress();
                startTimer();
            }
        }, 1000);
    }

    // Zamanlayıcıyı duraklat
    function pauseTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        startBtn.disabled = false;
        showNotification('⏸️ Zamanlayıcı duraklatıldı');
    }

    // Zamanlayıcıyı sıfırla
    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        startBtn.disabled = false;
        isWorkPhase = true;
        workTime = parseInt(workDurationInput.value) * 60;
        breakTime = parseInt(breakDurationInput.value) * 60;
        timeLeft = workTime;
        timerDisplay.textContent = formatTime(timeLeft);
        completedSessions = 0;
        currentSession = 1;
        updatePhaseDisplay();
        updateProgressBar();
        updateMotivationMessage();
        updateSessionProgress();
        updateStats();
        showNotification('🔄 Zamanlayıcı sıfırlandı');
    }

    // Event listeners
    workDurationInput.addEventListener('change', function() {
        if (!isRunning) {
            workTime = parseInt(this.value) * 60;
            if (isWorkPhase) {
                timeLeft = workTime;
                timerDisplay.textContent = formatTime(timeLeft);
                updateProgressBar();
            }
        }
    });

    breakDurationInput.addEventListener('change', function() {
        if (!isRunning) {
            breakTime = parseInt(this.value) * 60;
            if (!isWorkPhase) {
                timeLeft = breakTime;
                timerDisplay.textContent = formatTime(timeLeft);
                updateProgressBar();
            }
        }
    });

    sessionCountInput.addEventListener('change', function() {
        totalSessions = parseInt(this.value);
        totalSessions = Math.max(1, Math.min(20, totalSessions));
        
        if (currentSession > totalSessions) currentSession = totalSessions;
        if (completedSessions > totalSessions) completedSessions = totalSessions;
        
        updatePhaseDisplay();
        updateSessionProgress();
    });

    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', resetTimer);

    // Başlangıçta güncellemeler
    updateProgressBar();
    updateMotivationMessage();
    updatePhaseDisplay();
    updateSessionProgress();
    updateStats();
</script>
{% endblock %}