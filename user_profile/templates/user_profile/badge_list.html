{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .badge-section {
        margin-bottom: 25px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    
    .badge-header {
        padding: 15px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .badge-icon-large {
        font-size: 1.2rem;
        margin-right: 10px;
    }
    
    .badge-card {
        border-radius: 8px;
        overflow: hidden;
        height: 100%;
        transition: transform 0.3s;
        position: relative;
        margin-bottom: 15px;
        border: 1px solid #eee;
    }
    
    .badge-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .badge-card .card-header {
        padding: 8px;
        text-align: center;
        font-weight: bold;
        font-size: 0.8rem;
    }
    
    .badge-card .card-body {
        padding: 12px;
        text-align: center;
    }
    
    .badge-icon {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }
    
    .earned-badge {
        border: 2px solid #28a745;
    }
    
    .unearned-badge {
        opacity: 0.6;
        border: 1px dashed #aaa;
    }
    
    .earned-label {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.65rem;
        font-weight: bold;
    }
    
    .progress-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .progress-circle {
        position: relative;
        width: 130px;
        height: 130px;
        margin: 0 auto 15px;
    }
    
    .progress-circle svg {
        transform: rotate(-90deg);
    }
    
    .progress-circle circle {
        fill: transparent;
        stroke: #e9ecef;
        stroke-width: 8;
    }
    
    .progress-circle circle.progress {
        stroke: #4CAF50;
        stroke-dasharray: 408;
        stroke-dashoffset: calc(408 - (408 * {{ progress_percentage }}) / 100);
        stroke-linecap: round;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.4rem;
        font-weight: bold;
        color: #495057;
    }
    
    .criteria-list {
        list-style-type: none;
        padding-left: 0;
        font-size: 0.75rem;
        margin-bottom: 0;
    }
    
    .section-title {
        font-size: 1.1rem;
        margin: 15px 0 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
        font-weight: 600;
    }
    
    .badge-type-icon {
        font-size: 1.1rem;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .badge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }
    
    .main-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #333;
    }
    
    .sub-title {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="progress-section">
        <div class="d-flex justify-content-center align-items-center mb-3">
            <h1 class="main-title mb-0">Rozet Koleksiyonun</h1>
            <span class="badge bg-info ms-3" style="font-size: 0.9rem;">
                {{ earned_badges_count }} / {{ total_badges }} rozet
            </span>
        </div>
        
        <div class="progress-circle">
            <svg width="130" height="130" viewBox="0 0 130 130">
                <circle cx="65" cy="65" r="60"></circle>
                <circle class="progress" cx="65" cy="65" r="60"></circle>
            </svg>
            <div class="progress-text">
                {{ progress_percentage|floatformat:"0" }}%
            </div>
        </div>
        
        <div class="mt-3">
            {% if earned_badges_count < total_badges %}
                <p class="lead fs-6">Daha <strong>{{ total_badges|add:"-earned_badges_count" }} rozet</strong> kazanabilirsin!</p>
            {% else %}
                <p class="lead text-success fw-bold fs-6">TÃ¼m rozetleri kazandÄ±n! ðŸŽ‰</p>
            {% endif %}
        </div>
    </div>

    <!-- KazanÄ±lan Rozetler -->
    {% if earned_badges %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white py-2">
            <h2 class="mb-0 fs-6">
                <i class="fas fa-trophy me-2"></i>
                KazandÄ±ÄŸÄ±n Rozetler
            </h2>
            <p class="mb-0 small">BaÅŸarÄ±larÄ±nÄ± kutla! Yeni rozetler kazanmaya devam et.</p>
        </div>
        <div class="card-body p-2">
            <div class="badge-grid">
                {% for badge in earned_badges %}
                <a href="{% url 'user_profile:badge_detail' badge.slug %}" 
                   class="text-decoration-none">
                    <div class="card badge-card earned-badge">
                        <div class="card-header" style="background-color: {{ badge.badge_type.color|default:'#6c757d' }}; color: white;">
                            <i class="{{ badge.badge_type.icon|default:'fas fa-medal' }}"></i>
                            <div class="mt-1">{{ badge.name|truncatechars:12 }}</div>
                        </div>
                        <div class="card-body">
                            <div class="badge-icon" style="color: {{ badge.badge_type.color|default:'#6c757d' }};">
                                <i class="{{ badge.badge_type.icon|default:'fas fa-medal' }}"></i>
                            </div>
                        </div>
                        <div class="earned-label">
                            <i class="fas fa-check me-1"></i> KazanÄ±ldÄ±
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- TÃ¼m Rozetler -->
    <div class="mt-4">
        <h2 class="main-title text-center">
            <i class="fas fa-medal me-2"></i>
            TÃ¼m Rozetler
        </h2>
        <p class="sub-title text-center">FarklÄ± kategorilerde kazanabileceÄŸin rozetler</p>
        
        {% for badge_type in badge_types %}
        <div class="badge-section">
            <div class="badge-header" style="background-color: {{ badge_type.color|default:'#6c757d' }};">
                <div>
                    <h3 class="mb-0 fs-6">
                        <i class="{{ badge_type.icon|default:'fas fa-medal' }} badge-type-icon"></i>
                        {{ badge_type.name }}
                    </h3>
                    <p class="mb-0 small">{{ badge_type.description }}</p>
                </div>
                <span class="badge bg-light text-dark fs-6">
                    {{ badge_type.earned_count }} / {{ badge_type.total_count }}
                </span>
            </div>
            
            <div class="bg-white p-3">
                <!-- KazanÄ±lan Rozetler -->
                {% if badge_type.badges.earned %}
                <h4 class="section-title">KazanÄ±lan Rozetler</h4>
                <div class="badge-grid">
                    {% for badge in badge_type.badges.earned %}
                    <a href="{% url 'user_profile:badge_detail' badge.slug %}" 
                       class="text-decoration-none">
                        <div class="card badge-card earned-badge">
                            <div class="card-header" style="background-color: {{ badge_type.color|default:'#6c757d' }}; color: white;">
                                <i class="{{ badge_type.icon|default:'fas fa-medal' }}"></i>
                                <div class="mt-1">{{ badge.name|truncatechars:12 }}</div>
                            </div>
                            <div class="card-body">
                                <div class="badge-icon" style="color: {{ badge_type.color|default:'#6c757d' }};">
                                    <i class="{{ badge_type.icon|default:'fas fa-medal' }}"></i>
                                </div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- KazanÄ±lmayan Rozetler -->
                {% if badge_type.badges.unearned %}
                <h4 class="section-title">KazanÄ±lmayan Rozetler</h4>
                <div class="badge-grid">
                    {% for badge in badge_type.badges.unearned %}
                    <div class="card badge-card unearned-badge" 
                         data-bs-toggle="tooltip" 
                         title="{{ badge.description }}">
                        <div class="card-header" style="background-color: #f5f5f5; color: #777;">
                            <i class="{{ badge_type.icon|default:'fas fa-medal' }}"></i>
                            <div class="mt-1">{{ badge.name|truncatechars:12 }}</div>
                        </div>
                        <div class="card-body">
                            <div class="badge-icon" style="color: #d3d3d3;">
                                <i class="{{ badge_type.icon|default:'fas fa-medal' }}"></i>
                            </div>
                        </div>
                        <div class="card-footer bg-light p-1 text-center">
                            <small class="text-muted">Kazanmak iÃ§in:</small>
                            <ul class="criteria-list">
                                {% for criterion in badge.get_criteria_display|slice:":1" %}
                                <li>{{ criterion|truncatechars:25 }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Rozet koleksiyonu ilerleme Ã§emberi
document.addEventListener('DOMContentLoaded', function() {
    const progressCircle = document.querySelector('.progress-circle circle.progress');
    if (progressCircle) {
        const radius = progressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        
        progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        progressCircle.style.strokeDashoffset = circumference;
        
        const progressPercentage = {{ progress_percentage }};
        const offset = circumference - (progressPercentage / 100 * circumference);
        progressCircle.style.strokeDashoffset = offset;
    }
    
    // Tooltip aktivasyonu
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            placement: 'top'
        })
    });
});
</script>
{% endblock %}